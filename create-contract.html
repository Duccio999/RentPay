<script>
/* ===== Nav mobile ===== */
(function(){
  const b=document.getElementById('rpHamburger'),d=document.getElementById('rpDrawer'),x=document.getElementById('rpDrawerClose'),o=document.getElementById('rpBackdrop');
  function open(){d.classList.add('open');o.hidden=false;o.classList.add('show');document.body.style.overflow='hidden'}
  function close(){d.classList.remove('open');o.classList.remove('show');o.hidden=true;document.body.style.overflow=''}
  b&&b.addEventListener('click',open); x&&x.addEventListener('click',close); o&&o.addEventListener('click',close); window.addEventListener('keydown',e=>{if(e.key==='Escape')close()});
})();

/* ===== Logica pagina ===== */
(function(){
  if(!window.RP){ alert('Errore di caricamento store'); location.href='login.html'; return; }
  const me = RP.me();
  if(!me || (me.role!=='landlord' && me.ruolo!=='proprietario')){ location.href='login.html'; return; }

  const owner    = document.getElementById('owner');
  const tenantSel= document.getElementById('tenantSel');
  const addr     = document.getElementById('addr');
  const rent     = document.getElementById('rent');
  const start    = document.getElementById('start');
  const months   = document.getElementById('months');
  const btn      = document.getElementById('btnSubmit');

  owner.value = `${me.name || me.nome} — ${me.email}`;

  const db = RP.read();

  // --- PRESET per-tenant: riconosco per email/nome/id in modo robusto
  //   (modifica liberamente i valori qui sotto)
  const TENANT_PRESETS = {
    // Giulia Neri
    'giulia':  { address:'Via Po 8, Torino',  rent:720, start:'2025-10-01', months:12 },
    // Luca Bianchi
    'luca':    { address:'Via Roma 12, Milano', rent:850, start:'2025-06-01', months:18 }
  };

  function findPreset(t){
    const key = `${t.email||''} ${t.nome||t.name||''} ${t.id||''}`.toLowerCase();
    if(key.includes('giulia')) return TENANT_PRESETS.giulia;
    if(key.includes('luca'))   return TENANT_PRESETS.luca;
    return null;
  }

  // Popola select inquilini
  db.utenti.inquilini.forEach(t=>{
    const opt=document.createElement('option');
    opt.value=t.id;
    opt.textContent=`${t.nome || t.name} — ${t.email}`;
    tenantSel.appendChild(opt);
  });

  // Applica SEMPRE i default del tenant selezionato (l’utente può poi modificarli)
  function applyTenantDefaults(){
    const t = db.utenti.inquilini.find(x=>x.id===tenantSel.value);
    if(!t) return;

    const p = findPreset(t) || {
      address: t.indirizzo || '',
      rent:    (typeof t.affitto !== 'undefined') ? t.affitto : '',
      start:   '',
      months:  12
    };

    addr.value   = p.address || '';
    rent.value   = p.rent    ?? '';
    months.value = p.months  ?? 12;

    if(p.start){
      start.value = p.start;
    }else{
      // fallback: oggi
      const today=new Date();
      const y=today.getFullYear(), m=String(today.getMonth()+1).padStart(2,'0'), d=String(today.getDate()).padStart(2,'0');
      start.value = `${y}-${m}-${d}`;
    }
  }

  tenantSel.addEventListener('change', applyTenantDefaults);

  // Inizializzazione: seleziona primo inquilino e applica preset
  if(tenantSel.options.length){
    tenantSel.selectedIndex = 0;
    applyTenantDefaults();
  }

  btn.addEventListener('click', (e)=>{
    e.preventDefault();
    const tenantId = tenantSel.value;
    const address  = addr.value.trim();
    const rentNum  = parseFloat(rent.value||'0') || 0;
    const startIso = start.value;
    const monthsNum= parseInt(months.value||'12') || 12;

    if(!tenantId || !address || !startIso){
      alert('Compila inquilino, indirizzo e data inizio.');
      return;
    }

    const dbNow = RP.read();
    const newId = 'C' + Date.now();
    dbNow.contratti.push({
      id: newId,
      landlordId: me.id,
      tenantId,
      address,
      rent: rentNum,
      start: startIso,
      months: monthsNum,
      status: 'pending_tenant'
    });
    RP.write(dbNow);

    alert('Contratto creato e inviato all’inquilino (DEMO).');
    location.href = 'dashboard-prop.html';
  });
})();
</script>
