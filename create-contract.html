<script src="rp-store.js"></script>
<script>
/* nav */
(function(){
  const b=rpHamburger,d=rpDrawer,x=rpDrawerClose,o=rpBackdrop;
  function open(){d.classList.add('open');o.hidden=false;o.classList.add('show');document.body.style.overflow='hidden'}
  function close(){d.classList.remove('open');o.classList.remove('show');o.hidden=true;document.body.style.overflow=''}
  b&&b.addEventListener('click',open);x&&x.addEventListener('click',close);o&&o.addEventListener('click',close);
  window.addEventListener('keydown',e=>{if(e.key==='Escape')close()});
})();

/* === Logica create-contract === */
const me = RP.me();
if(!me || me.role!=='landlord'){ location.replace('login.html'); }

document.getElementById('landlord').value = me.name;

// Popola select inquilini
const sel = document.getElementById('tenant');
RP.users.tenants().forEach(t=>{
  const o=document.createElement('option');
  o.value=t.id;
  o.textContent=`${t.name} — ${t.email}`;
  sel.appendChild(o);
});

// Prefill con primo inquilino
function prefill(t){
  document.getElementById('address').value = t.address;
  document.getElementById('rent').value    = t.rent;
  const dt=new Date(), y=dt.getFullYear(), m=dt.getMonth();
  document.getElementById('start').value = RP.contracts.ymd(new Date(y,m,1));
}
prefill(RP.users.tenants()[0]);

sel.addEventListener('change', ()=>{
  const t = RP.users.tenants().find(x=>x.id===sel.value);
  if(t) prefill(t);
});

document.getElementById('f').addEventListener('submit', e=>{
  e.preventDefault();
  const tId = sel.value;
  const newId = RP.contracts.create({
    landlordId: me.id,
    tenantId: tId,
    address: document.getElementById('address').value,
    rent: Number(document.getElementById('rent').value||0),
    start: document.getElementById('start').value,
    months: Number(document.getElementById('months').value||0)
  });
  alert('Contratto creato (DEMO). Inviato all’inquilino per la firma.');
  location.href = 'dashboard-prop.html';
});
</script>
