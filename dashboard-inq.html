<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Dashboard Inquilino ‚Äî RentPay</title>
  <link rel="stylesheet" href="styles.css?v=fix9">
</head>
<body>
<!-- NAV -->
<nav class="rp-nav">
  <a class="rp-brand" href="./index.html" aria-label="RentPay Home">
    <span class="rp-house">üè†</span><span class="rp-brand-text">RentPay</span>
  </a>
  <div class="rp-menu-desktop">
    <a href="index.html">Home</a>
    <a href="funzioni.html">Funzioni</a>
    <a href="prezzi.html">Prezzi</a>
    <a class="rp-accent" href="login.html">Cambia account</a>
  </div>
  <button id="rpHamburger" class="rp-hamburger" aria-label="Apri menu" aria-expanded="false">‚ò∞</button>
</nav>
<aside id="rpDrawer" class="rp-drawer" aria-hidden="true">
  <div class="rp-drawer-head">
    <span>Men√π</span>
    <button id="rpDrawerClose" class="rp-close" aria-label="Chiudi menu">√ó</button>
  </div>
  <a href="index.html">Home</a>
  <a href="funzioni.html">Funzioni</a>
  <a href="prezzi.html">Prezzi</a>
  <a class="rp-accent" href="login.html">Cambia account</a>
</aside>
<div id="rpBackdrop" class="rp-backdrop" hidden></div>

<main class="container narrow">
  <!-- HERO -->
  <section class="hero card center">
    <h1>I miei contratti</h1>
    <p class="lead">Scarica il PDF, firma quando sei pronto. Dopo la firma, il contratto passa tra i firmati.</p>
  </section>

  <!-- CONTRATTI DA FIRMARE -->
  <section class="card section">
    <div class="section-head">
      <h2>Contratti da firmare</h2>
    </div>
    <div class="table-wrap edge">
      <table class="rp-table">
        <thead>
          <tr>
            <th>Immobile</th>
            <th>Canone</th>
            <th>Dal</th>
            <th>Durata</th>
            <th>Azioni</th>
          </tr>
        </thead>
        <tbody id="toSign"></tbody>
      </table>
    </div>
  </section>

  <!-- CONTRATTI FIRMATI -->
  <section class="card section">
    <div class="section-head">
      <h2>Contratti firmati</h2>
    </div>
    <div class="table-wrap edge">
      <table class="rp-table">
        <thead>
          <tr>
            <th>Immobile</th>
            <th>Canone</th>
            <th>Dal</th>
            <th>Durata</th>
            <th>Azioni</th>
          </tr>
        </thead>
        <tbody id="signed"></tbody>
      </table>
    </div>
  </section>
</main>

<footer class="footer container">
  <div class="f-links">
    <a href="terms.html">Termini</a>
    <a href="privacy.html">Privacy</a>
    <a href="cookie.html">Cookie</a>
  </div>
  <div class="copy">¬© 2025 RentPay ‚Äî PWA</div>
</footer>

<!-- Store -->
<script src="rp-store.js"></script>

<script>
/* ===== Nav mobile ===== */
(function(){
  const btn=document.getElementById('rpHamburger'),
        drawer=document.getElementById('rpDrawer'),
        closeBtn=document.getElementById('rpDrawerClose'),
        backdrop=document.getElementById('rpBackdrop');
  function openD(){drawer.classList.add('open');backdrop.hidden=false;backdrop.classList.add('show');document.body.style.overflow='hidden'}
  function closeD(){drawer.classList.remove('open');backdrop.classList.remove('show');backdrop.hidden=true;document.body.style.overflow=''}
  btn&&btn.addEventListener('click',openD);
  closeBtn&&closeBtn.addEventListener('click',closeD);
  backdrop&&backdrop.addEventListener('click',closeD);
  window.addEventListener('keydown',e=>{if(e.key==='Escape')closeD()});
})();

/* ===== Dashboard Inquilino ===== */
(function(){
  const DEFAULT_PDF = 'contratto_locazione.pdf'; // <-- cambia se lo metti in /assets/
  if(!window.RP){ alert('Errore caricamento store'); location.href='login.html'; return; }

  const me = RP.me();
  if(!me || (me.role!=='tenant' && me.ruolo!=='inquilino')){ location.href='login.html'; return; }

  const toSignTB = document.getElementById('toSign');
  const signedTB = document.getElementById('signed');

  const fmtEUR = (n)=> new Intl.NumberFormat('it-IT', {style:'currency', currency:'EUR', maximumFractionDigits:0}).format(n);

  function rowHTML(c){
    const pdf = c.pdfUrl || DEFAULT_PDF;
    const months = (c.months != null) ? `${c.months} mesi` : '-';
    const isPending = (c.status === 'pending_tenant') || (c.signed && c.signed.tenant === false);

    return `
      <tr>
        <td>${c.address || '-'}</td>
        <td>${fmtEUR(c.rent||0)}</td>
        <td>${c.start || '-'}</td>
        <td>${months}</td>
        <td style="white-space:nowrap">
          <a class="btn ghost" href="${pdf}" target="_blank" rel="noopener">üìÑ PDF</a>
          ${isPending
            ? `<button class="btn primary" data-sign="${c.id}">‚úçÔ∏è Firma</button>`
            : `<a class="btn primary" href="${pdf}" target="_blank" rel="noopener">üìÑ PDF firmato</a>`
          }
        </td>
      </tr>
    `;
  }

  function render(){
    const db = RP.read();
    const mine = db.contratti.filter(c => c.tenantId === me.id);

    const pending = mine.filter(c => (c.status === 'pending_tenant') || (c.signed && c.signed.tenant === false));
    const active  = mine.filter(c => !pending.includes(c));

    toSignTB.innerHTML = pending.length ? pending.map(rowHTML).join('') : `<tr><td colspan="5">Nessun contratto in attesa di firma.</td></tr>`;
    signedTB.innerHTML = active.length  ? active.map(rowHTML).join('')  : `<tr><td colspan="5">Nessun contratto firmato.</td></tr>`;
  }

  // click delegato per FIRMA
  document.addEventListener('click', (e)=>{
    const id = e.target && e.target.dataset && e.target.dataset.sign;
    if(!id) return;

    const db = RP.read();
    const c = db.contratti.find(x => x.id === id);
    if(!c) return;

    // inizializza se mancano i campi
    c.signed = c.signed || { landlord:false, tenant:false };
    c.pdfUrl = c.pdfUrl || DEFAULT_PDF;

    c.signed.tenant = true;
    c.status = 'active'; // ora il contratto risulta attivo

    RP.write(db);
    alert('Hai firmato il contratto! Puoi scaricare il PDF tra i Contratti firmati.');
    render();
  });

  // prima render
  render();
})();
</script>
</body>
</html>
