<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Dashboard Inquilino ‚Äî RentPay</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>

<nav class="rp-nav">
  <a class="rp-brand" href="./index.html"><span class="rp-house">üè†</span><span class="rp-brand-text">RentPay</span></a>
  <div class="rp-menu-desktop">
    <a href="./index.html">Home</a>
    <a href="./vision.html">Visione</a>
    <a href="./funzioni.html">Funzioni</a>
    <a href="./garanzia.html">Garanzia</a>
    <a href="./prezzi.html">Prezzi</a>
    <a href="./firma.html">Firma (demo)</a>
    <a class="rp-accent" href="./login.html">Accedi</a>
  </div>
  <button id="rpHamburger" class="rp-hamburger" aria-label="Apri menu" aria-expanded="false">‚ò∞</button>
</nav>
<aside id="rpDrawer" class="rp-drawer" aria-hidden="true">
  <div class="rp-drawer-head"><span class="rp-drawer-title">Men√π</span><button id="rpDrawerClose" class="rp-close">√ó</button></div>
  <a href="./index.html">Home</a>
  <a href="./vision.html">Visione</a>
  <a href="./funzioni.html">Funzioni</a>
  <a href="./garanzia.html">Garanzia</a>
  <a href="./prezzi.html">Prezzi</a>
  <a href="./firma.html">Firma (demo)</a>
  <a class="rp-accent" href="./login.html">Accedi</a>
</aside>
<div id="rpBackdrop" class="rp-backdrop" hidden></div>

<main class="container">
  <section class="hero card">
    <h1>Dashboard Inquilino</h1>
    <p class="lead">Qui trovi i contratti da firmare e quelli attivi. DEMO: le firme non sono vincolanti.</p>
  </section>

  <section class="card">
    <h2>‚úçÔ∏è Contratti da firmare</h2>
    <div id="tblSign" class="table-wrap" style="margin-top:8px"></div>
  </section>

  <section class="card">
    <h2>üìÑ Contratti attivi</h2>
    <div id="tblActive" class="table-wrap" style="margin-top:8px"></div>
  </section>
</main>

<footer class="footer container">
  <div class="f-links">
    <a href="terms.html">Termini di servizio</a>
    <a href="privacy.html">Privacy Policy</a>
    <a href="cookie.html">Cookie Policy</a>
  </div>
  <div class="copy">¬© <span id="year"></span> RentPay ‚Äî PWA</div>
</footer>

<script src="app.js"></script>
<script src="rp-store.js"></script>
<script src="rp-badge.js"></script>
  <script>
(function () {
  if (!window.RP) return;

  const qs = new URLSearchParams(location.search);
  const demo = qs.get('demo');           // "proprietario" | "inquilino"
  const i    = parseInt(qs.get('i') || '0', 10);

  // 1) Se non c'√® utente loggato, prova a bootstrapparlo dai profili demo passati in query
  if (!RP.me()) {
    if (demo === 'proprietario' && RP._demo?.landlords?.length) {
      RP.login(RP._demo.landlords[i] || RP._demo.landlords[0]);
    } else if (demo === 'inquilino' && RP._demo?.tenants?.length) {
      RP.login(RP._demo.tenants[i] || RP._demo.tenants[0]);
    }
  }

  // 2) Se ancora non c'√® utente -> torna al login
  if (!RP.me()) {
    location.href = './login.html';
    return;
  }

  // 3) Se sono proprietario e non ho contratti, semino 2 contratti demo per popolare la UI
  const me = RP.me();
  if (me.role === 'landlord') {
    const mine = RP.listContracts({ landlordId: me.id });
    if (!mine || mine.length === 0) {
      // prendi due inquilini demo se disponibili
      const t1 = RP._demo?.tenants?.[0];
      const t2 = RP._demo?.tenants?.[1] || RP._demo?.tenants?.[0];

      if (t1) RP.createContract({
        landlordId: me.id,
        tenantId: t1.id,
        address: 'Via Roma 12',
        rent: 850,
        status: 'pending_tenant'
      });

      if (t2) RP.createContract({
        landlordId: me.id,
        tenantId: t2.id,
        address: 'Via Po 8',
        rent: 720,
        status: 'active'
      });
    }
  }
})();
</script>
<script type="text/javascript" data-cookieconsent="ignore">
(function(){
  const btn=document.getElementById('rpHamburger'), d=document.getElementById('rpDrawer'), x=document.getElementById('rpDrawerClose'), b=document.getElementById('rpBackdrop');
  function openD(){d.classList.add('open');b.hidden=false;b.classList.add('show');document.body.style.overflow='hidden'}
  function closeD(){d.classList.remove('open');b.classList.remove('show');b.hidden=true;document.body.style.overflow=''}
  btn&&btn.addEventListener('click',openD); x&&x.addEventListener('click',closeD); b&&b.addEventListener('click',closeD);
  d.querySelectorAll('a').forEach(a=>a.addEventListener('click',closeD));
})();
</script>

<script>
(function renderTenant(){
  const me = RP.me();
  if(!me || !/^t/.test(me.id)){ location.href='login.html'; return; }

  const toSign = RP.listContracts({tenantId:me.id, status:'pending_tenant'});
  const active = RP.listContracts({tenantId:me.id, status:'active'});

  function rowsToSign(list){
    if(!list.length) return '<div class="small" style="padding:12px">Nessun documento in attesa.</div>';
    return `
      <table class="rp-table">
        <thead><tr>
          <th>Immobile</th><th>Proprietario</th><th>Canone</th><th>Periodo</th><th></th>
        </tr></thead>
        <tbody>
        ${list.map(c=>{
          const l = RP.userById(c.landlordId)||{};
          const per = \`${new Date(c.start).toLocaleDateString('it-IT')} ¬∑ ${c.months} mesi\`;
          const can = new Intl.NumberFormat('it-IT',{style:'currency',currency:'EUR'}).format(c.rent);
          return `<tr>
            <td>${c.address||'-'}</td>
            <td>${l.name||'-'}</td>
            <td>${can}</td>
            <td>${per}</td>
            <td><a class="btn primary" href="firma.html?cid=${encodeURIComponent(c.id)}">Apri & Firma</a></td>
          </tr>`;
        }).join('')}
        </tbody>
      </table>
    `;
  }

  function rowsActive(list){
    if(!list.length) return '<div class="small" style="padding:12px">Nessun contratto attivo.</div>';
    return `
      <table class="rp-table">
        <thead><tr>
          <th>Immobile</th><th>Proprietario</th><th>Canone</th><th>Periodo</th><th>Stato</th>
        </tr></thead>
        <tbody>
        ${list.map(c=>{
          const l = RP.userById(c.landlordId)||{};
          const per = \`${new Date(c.start).toLocaleDateString('it-IT')} ¬∑ ${c.months} mesi\`;
          const can = new Intl.NumberFormat('it-IT',{style:'currency',currency:'EUR'}).format(c.rent);
          return `<tr>
            <td>${c.address||'-'}</td>
            <td>${l.name||'-'}</td>
            <td>${can}</td>
            <td>${per}</td>
            <td>Attivo</td>
          </tr>`;
        }).join('')}
        </tbody>
      </table>
    `;
  }

  document.getElementById('tblSign').innerHTML   = rowsToSign(toSign);
  document.getElementById('tblActive').innerHTML = rowsActive(active);

  if(new URLSearchParams(location.search).get('signed')==='1'){
    setTimeout(()=>alert('Firma registrata (demo).'), 200);
  }
})();
</script>
</body>
</html>
