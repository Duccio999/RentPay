<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Dashboard Inquilino ‚Äî RentPay (DEMO)</title>
  <link rel="stylesheet" href="styles.css">
  <style>
    /* Spaziatura morbida tra i box */
    .stack { display:flex; flex-direction:column; gap:32px }
    @media (min-width:900px){ .stack{gap:36px} }

    /* Profilo: layout verticale su mobile */
    .kv { display:grid; grid-template-columns:1fr; gap:8px 0 }
    .kv b { display:block; font-weight:600; margin-top:6px }

    /* Tabelle scrollabili come richiesto */
    .table-wrap { overflow-x:auto; -webkit-overflow-scrolling:touch }

    /* Head di sezione (se in futuro vorrai bottoni) */
    .section-head { display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap }
  </style>
</head>
<body>
<!-- NAV -->
<nav class="rp-nav">
  <a class="rp-brand" href="./index.html"><span class="rp-house">üè†</span><span class="rp-brand-text">RentPay</span></a>
  <div class="rp-menu-desktop">
    <a href="funzioni.html">Funzioni</a>
    <a class="rp-accent" href="login.html">Cambia account</a>
  </div>
  <button id="rpHamburger" class="rp-hamburger" aria-label="Apri menu">‚ò∞</button>
</nav>

<!-- Drawer mobile -->
<aside id="rpDrawer" class="rp-drawer" aria-hidden="true">
  <div class="rp-drawer-head"><span>Men√π</span><button id="rpDrawerClose" class="rp-close">√ó</button></div>
  <a href="funzioni.html">Funzioni</a>
  <a class="rp-accent" href="login.html">Cambia account</a>
</aside>
<div id="rpBackdrop" class="rp-backdrop" hidden></div>

<!-- CONTENUTO -->
<main class="container">
  <div class="stack">
    <section class="hero card">
      <h1 id="welcome">Dashboard Inquilino</h1>
      <p class="lead">Qui vedi i contratti, gli addebiti ricorrenti e le richieste di firma. (DEMO)</p>
    </section>

    <section class="card">
      <h2>Dati profilo</h2>
      <div class="kv" id="tenantKV"></div>
    </section>

    <section class="card">
      <div class="section-head">
        <h2>Contratti da firmare</h2>
      </div>
      <div class="table-wrap">
        <table class="rp-table" id="tblToSign">
          <thead>
            <tr>
              <th>Immobile</th>
              <th>Proprietario</th>
              <th>Canone</th>
              <th>Stato</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <section class="card">
      <h2>Contratti attivi</h2>
      <div class="table-wrap">
        <table class="rp-table" id="tblActive">
          <thead>
            <tr>
              <th>Immobile</th>
              <th>Proprietario</th>
              <th>Dal</th>
              <th>Canone</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <section class="card">
      <h2>Pagamenti recenti</h2>
      <div class="table-wrap">
        <table class="rp-table" id="tblPays">
          <thead>
            <tr>
              <th>Data</th>
              <th>Contratto</th>
              <th>Importo</th>
              <th>Stato</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>
  </div>
</main>

<!-- FOOTER -->
<footer class="footer container">
  <div class="f-links">
    <a href="terms.html">Termini</a>
    <a href="privacy.html">Privacy</a>
    <a href="cookie.html">Cookie</a>
  </div>
  <div class="copy">¬© 2025 RentPay ‚Äî PWA</div>
</footer>

<!-- Store condiviso -->
<script src="rp-store.js"></script>

<!-- NAV mobile -->
<script>
(function(){
  const b=document.getElementById('rpHamburger'),d=document.getElementById('rpDrawer'),
        x=document.getElementById('rpDrawerClose'),o=document.getElementById('rpBackdrop');
  function open(){d.classList.add('open');o.hidden=false;o.classList.add('show');document.body.style.overflow='hidden'}
  function close(){d.classList.remove('open');o.classList.remove('show');o.hidden=true;document.body.style.overflow=''}
  b&&b.addEventListener('click',open); x&&x.addEventListener('click',close); o&&o.addEventListener('click',close);
  window.addEventListener('keydown',e=>{if(e.key==='Escape') close()});
})();
</script>

<!-- LOGICA DASHBOARD INQUILINO (solo lettura dal seed demo) -->
<script>
(function(){
  if(!window.RP){ location.href='login.html'; return; }

  const me = RP.me();
  if(!me || me.role !== 'tenant'){ location.href='login.html'; return; }

  // Utility formattazioni
  const fmtEur = n => new Intl.NumberFormat('it-IT',{style:'currency',currency:'EUR'}).format(n);
  const fmtDMY = d => { if(!d) return ''; const [y,m,dd]=d.split('-'); return `${dd}/${m}/${y}`; };

  // Header
  document.getElementById('welcome').textContent = `Benvenuto, ${me.name}`;

  // DB completo dal seed
  const db = RP.read();

  // Map veloci
  const landlordsMap = Object.fromEntries(db.utenti.proprietari.map(l => [l.id, l]));
  const myContracts = db.contratti.filter(c => c.tenantId === me.id);

  // Profilo
  document.getElementById('tenantKV').innerHTML = `
    <b>Nome</b><div>${me.name}</div>
    <b>Email</b><div>${me.email}</div>
    <b>Indirizzo (dal contratto)</b><div>${myContracts[0]?.address || '-'}</div>
    <b>Canone (dal contratto)</b><div>${myContracts[0]? fmtEur(myContracts[0].rent) : '-'}</div>
  `;

  // Contratti da firmare
  const tbodySign = document.querySelector('#tblToSign tbody');
  const toSign = myContracts.filter(c => c.status === 'pending_tenant');
  tbodySign.innerHTML = toSign.length ? toSign.map(c => `
    <tr>
      <td>${c.address}</td>
      <td>${landlordsMap[c.landlordId]?.name || '-'}</td>
      <td>${fmtEur(c.rent)}</td>
      <td>In attesa firma</td>
    </tr>
  `).join('') : `<tr><td colspan="4">Nessun contratto da firmare.</td></tr>`;

  // Contratti attivi
  const tbodyAct = document.querySelector('#tblActive tbody');
  const active = myContracts.filter(c => c.status === 'active');
  tbodyAct.innerHTML = active.length ? active.map(c => `
    <tr>
      <td>${c.address}</td>
      <td>${landlordsMap[c.landlordId]?.name || '-'}</td>
      <td>${fmtDMY(c.start)}</td>
      <td>${fmtEur(c.rent)}</td>
    </tr>
  `).join('') : `<tr><td colspan="4">Nessun contratto attivo.</td></tr>`;

  // Pagamenti recenti (per i contratti dell'inquilino)
  const tbodyPays = document.querySelector('#tblPays tbody');
  const myContractIds = new Set(myContracts.map(c => c.id));
  const pays = db.pagamenti.filter(p => myContractIds.has(p.contractId));
  const contractsMap = Object.fromEntries(myContracts.map(c => [c.id, c]));
  tbodyPays.innerHTML = pays.length ? pays.map(p => `
    <tr>
      <td>${fmtDMY(p.data)}</td>
      <td>${contractsMap[p.contractId]?.address || '-'}</td>
      <td>${fmtEur(p.importo)}</td>
      <td>${p.stato === 'pagato' ? 'Completato' : '-'}</td>
    </tr>
  `).join('') : `<tr><td colspan="4">Nessun pagamento registrato (DEMO).</td></tr>`;
})();
</script>
</body>
</html>
