<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Dashboard Inquilino ‚Äî RentPay</title>
  <link rel="stylesheet" href="styles.css?v=fix9">
</head>
<body>
<!-- NAV -->
<nav class="rp-nav">
  <a class="rp-brand" href="./index.html" aria-label="RentPay Home">
    <span class="rp-house">üè†</span><span class="rp-brand-text">RentPay</span>
  </a>
  <div class="rp-menu-desktop">
    <a href="index.html">Home</a>
    <a href="funzioni.html">Funzioni</a>
    <a href="prezzi.html">Prezzi</a>
    <a class="rp-accent" href="login.html">Cambia account</a>
  </div>
  <button id="rpHamburger" class="rp-hamburger" aria-label="Apri menu" aria-expanded="false">‚ò∞</button>
</nav>
<aside id="rpDrawer" class="rp-drawer" aria-hidden="true">
  <div class="rp-drawer-head">
    <span>Men√π</span>
    <button id="rpDrawerClose" class="rp-close" aria-label="Chiudi menu">√ó</button>
  </div>
  <a href="index.html">Home</a>
  <a href="funzioni.html">Funzioni</a>
  <a href="prezzi.html">Prezzi</a>
  <a class="rp-accent" href="login.html">Cambia account</a>
</aside>
<div id="rpBackdrop" class="rp-backdrop" hidden></div>

<main class="container narrow">
  <!-- HERO -->
  <section class="hero card center">
    <h1>I miei contratti</h1>
    <p class="lead">Scarica il PDF, firma quando sei pronto. Dopo la firma, il contratto passa tra i firmati.</p>
  </section>

  <!-- CONTRATTI DA FIRMARE -->
  <section class="card section">
    <div class="section-head">
      <h2>Contratti da firmare</h2>
    </div>
    <div class="table-wrap edge">
      <table class="rp-table">
        <thead>
          <tr>
            <th>Immobile</th>
            <th>Canone</th>
            <th>Dal</th>
            <th>Durata</th>
            <th>Azioni</th>
          </tr>
        </thead>
        <tbody id="toSign"></tbody>
      </table>
    </div>
  </section>

  <!-- CONTRATTI FIRMATI -->
  <section class="card section">
    <div class="section-head">
      <h2>Contratti firmati</h2>
    </div>
    <div class="table-wrap edge">
      <table class="rp-table">
        <thead>
          <tr>
            <th>Immobile</th>
            <th>Canone</th>
            <th>Dal</th>
            <th>Durata</th>
            <th>Azioni</th>
          </tr>
        </thead>
        <tbody id="signed"></tbody>
      </table>
    </div>
  </section>

  <!-- RATE (AUTO) -->
  <section class="card section">
    <div class="section-head">
      <h2>Rate (pagamento automatico)</h2>
    </div>

    <!-- AUTOPAY TOGGLE (solo inquilino) -->
    <div class="card" style="margin:12px 0; padding:12px; border:1px solid rgba(255,255,255,.08); background:rgba(255,255,255,.03)">
      <div style="display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap">
        <div>
          <div style="font-weight:700">Addebito automatico (Autopay)</div>
          <div class="lead" style="margin:4px 0 0 0; font-size:.95rem">
            Attiva l‚Äôaddebito mensile automatico (demo). Il giorno di addebito √® impostato al <strong>1</strong>.
          </div>
        </div>

        <label style="display:flex; align-items:center; gap:10px; cursor:pointer; user-select:none">
          <input id="autopayToggle" type="checkbox" style="transform:scale(1.2)">
          <span id="autopayLabel" class="badge">‚Äî</span>
        </label>
      </div>
    </div>

    <p class="lead" style="margin-top:-6px">
      DEMO: l‚Äôaddebito ricorrente √® <strong>automatico</strong>. Quando apri la dashboard, eventuali rate scadute vengono processate (pagato / in ritardo / fallito) senza premere ‚ÄúPaga‚Äù.
    </p>

    <div class="table-wrap edge">
      <table class="rp-table">
        <thead>
          <tr>
            <th>Scadenza</th>
            <th>Immobile</th>
            <th>Importo</th>
            <th>Stato</th>
            <th>Azioni (demo)</th>
          </tr>
        </thead>
        <tbody id="tblUpcoming"></tbody>
      </table>
    </div>
  </section>

</main>

<footer class="footer container">
  <div class="f-links">
    <a href="terms.html">Termini</a>
    <a href="privacy.html">Privacy</a>
    <a href="cookie.html">Cookie</a>
  </div>
  <div class="copy">¬© 2025 RentPay ‚Äî PWA</div>
</footer>

<!-- Store -->
<script src="rp-store.js"></script>

<script>
/* ===== Nav mobile ===== */
(function(){
  const btn=document.getElementById('rpHamburger'),
        drawer=document.getElementById('rpDrawer'),
        closeBtn=document.getElementById('rpDrawerClose'),
        backdrop=document.getElementById('rpBackdrop');
  function openD(){drawer.classList.add('open');backdrop.hidden=false;backdrop.classList.add('show');document.body.style.overflow='hidden'}
  function closeD(){drawer.classList.remove('open');backdrop.classList.remove('show');backdrop.hidden=true;document.body.style.overflow=''}
  btn&&btn.addEventListener('click',openD);
  closeBtn&&closeBtn.addEventListener('click',closeD);
  backdrop&&backdrop.addEventListener('click',closeD);
  window.addEventListener('keydown',e=>{if(e.key==='Escape')closeD()});
})();

/* ===== Dashboard Inquilino ===== */
(function(){
  const DEFAULT_PDF = 'contratto_locazione.pdf'; // <-- cambia se lo metti in /assets/
  if(!window.RP){ alert('Errore caricamento store'); location.href='login.html'; return; }

  const me = RP.me();
  if(!me || (me.role!=='tenant' && me.ruolo!=='inquilino')){ location.href='login.html'; return; }

  // DEMO: pagamenti automatici.
  // Processiamo eventuali rate scadute automaticamente all'apertura (senza click su "Paga").
  try { RP.runAutoPayCron(); } catch(e) {}

  const toSignTB = document.getElementById('toSign');
  const signedTB = document.getElementById('signed');

  const fmtEUR = (n)=> new Intl.NumberFormat('it-IT', {style:'currency', currency:'EUR', maximumFractionDigits:0}).format(n);

  function rowHTML(c){
    const pdf = c.pdfUrl || DEFAULT_PDF;
    const months = (c.months != null) ? `${c.months} mesi` : '-';
    const isPending = (c.status === 'pending_tenant') || (c.signed && c.signed.tenant === false);

    return `
      <tr>
        <td>${c.address || '-'}</td>
        <td>${fmtEUR(c.rent||0)}</td>
        <td>${c.start || '-'}</td>
        <td>${months}</td>
        <td style="white-space:nowrap">
          <a class="btn ghost" href="${pdf}" target="_blank" rel="noopener">üìÑ PDF</a>
          ${isPending
            ? `<a class="btn primary" href="firma.html?cid=${c.id}">‚úçÔ∏è Firma</a>`
            : `<a class="btn primary" href="${pdf}" target="_blank" rel="noopener">üìÑ PDF firmato</a>`
          }</td>
      </tr>
    `;
  }

  function render(){
    const db = RP.read();
    const mine = db.contratti.filter(c => c.tenantId === me.id);

    const pending = mine.filter(c => (c.status === 'pending_tenant') || (c.signed && c.signed.tenant === false));
    const active  = mine.filter(c => !pending.includes(c));

    toSignTB.innerHTML = pending.length ? pending.map(rowHTML).join('') : `<tr><td colspan="5">Nessun contratto in attesa di firma.</td></tr>`;
    signedTB.innerHTML = active.length  ? active.map(rowHTML).join('')  : `<tr><td colspan="5">Nessun contratto firmato.</td></tr>`;
  }

  // ===== Prossime rate + simulazione pagamento =====
  const upTB = document.getElementById('tblUpcoming');

  const fmtDMY = (iso)=>{
    if(!iso) return '-';
    const [y,m,d] = iso.split('-');
    return `${d}/${m}/${y}`;
  };

  const badge = (s)=>{
    const map = { scheduled:'Programmato', paid:'Pagato', failed:'Fallito', late:'In ritardo' };
    const lbl = map[s] || s;
    const cls = (s==='paid') ? 'badge ok' : (s==='failed') ? 'badge bad' : (s==='late') ? 'badge warn' : 'badge';
    return `<span class="${cls}">${lbl}</span>`;
  };

  function renderUpcoming(){
    const db = RP.read();
    const contractsById = { ...Object.fromEntries(db.contratti.map(c=>[c.id,c])) };

    // Mostriamo un "range" credibile per demo: ultimi 2 mesi + prossimi 4 mesi
    const today = new Date();
    const from = new Date(today.getFullYear(), today.getMonth()-2, 1);
    const to   = new Date(today.getFullYear(), today.getMonth()+4, 1);
    const fromIso = `${from.getFullYear()}-${String(from.getMonth()+1).padStart(2,'0')}-01`;
    const toIso   = `${to.getFullYear()}-${String(to.getMonth()+1).padStart(2,'0')}-31`;

    // contratti "validi" per mostrare rate: active o signed (demo)
    const mineContractIds = new Set(
      db.contratti
        .filter(c=>c.tenantId===me.id && (c.status==='active' || c.status==='signed'))
        .map(c=>c.id)
    );

    const rows = db.rate
      .filter(r=> mineContractIds.has(r.contractId) && r.dueDate >= fromIso && r.dueDate <= toIso)
      .sort((a,b)=>a.dueDate.localeCompare(b.dueDate))
      .slice(0, 10);

    upTB.innerHTML = rows.length ? rows.map(r=>{
      const c = contractsById[r.contractId] || {};
      const imm = c.address || c.indirizzo || '-';
      const amount = fmtEUR(r.amount||0);
      return `
        <tr>
          <td>${fmtDMY(r.dueDate)}</td>
          <td>${imm}</td>
          <td>${amount}</td>
          <td>${badge(r.status)}</td>
          <td style="white-space:nowrap">
            <span class="micro" style="opacity:.85">Autopay ${c.autopay?.enabled ? 'attivo' : 'spento'}</span>
            <button class="btn ghost" data-pay-late="${r.id}">‚è±Ô∏è Simula ritardo</button>
            <button class="btn" data-pay-fail="${r.id}">‚ùå Simula fallito</button>
          </td>
        </tr>
      `;
    }).join('') : `<tr><td colspan="5">Nessuna rata nel range selezionato.</td></tr>`;
  }

  document.addEventListener('click', (e)=>{
    const late = e.target?.getAttribute?.('data-pay-late');
    const fail = e.target?.getAttribute?.('data-pay-fail');
    if(late){
      RP.setRateStatus(late, 'late');
      renderUpcoming();
      return;
    }
    if(fail){
      RP.setRateStatus(fail, 'failed');
      renderUpcoming();
      return;
    }
  });

  // ===== Autopay toggle (solo inquilino) =====
  const toggle = document.getElementById('autopayToggle');
  const label  = document.getElementById('autopayLabel');

  function renderAutopay(){
    const db = RP.read();

    // prendiamo un contratto "valido" (active o signed) dell'inquilino
    const activeMine = db.contratti.find(c =>
      c.tenantId === me.id && (c.status === 'active' || c.status === 'signed' || c.status === 'pending_landlord' || c.status === 'pending_payment')
    );

    if(!activeMine){
      if(toggle) toggle.disabled = true;
      if(label)  label.textContent = 'Nessun contratto';
      return;
    }

    const enabled = !!activeMine.autopay?.enabled;
    if(toggle) toggle.checked = enabled;

    if(label){
      label.textContent = enabled ? 'Attivo' : 'Disattivo';
      label.className = enabled ? 'badge ok' : 'badge';
    }

    if(toggle && !toggle.dataset.bound){
      toggle.dataset.bound = '1';
      toggle.addEventListener('change', () => {
        RP.setAutopay(activeMine.id, toggle.checked, 1);
        try { RP.runAutoPayCron(); } catch(e) {}
        renderAutopay();
        renderUpcoming();
      });
    }
  }

  // Render iniziale
  render();
  renderAutopay();
  renderUpcoming();
})();
</script>
</body>
</html>
