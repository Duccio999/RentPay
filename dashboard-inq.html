<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Dashboard Inquilino - RentPay</title>
  <meta name="description" content="Panoramica demo del contratto e dei pagamenti per l'inquilino.">
  <link rel="stylesheet" href="styles.css">
</head>
<body>

<!-- NAVBAR -->
<nav class="rp-nav">
  <a class="rp-brand" href="./index.html" aria-label="RentPay Home">
    <span class="rp-house" aria-hidden="true">üè†</span>
    <span class="rp-brand-text">RentPay</span>
  </a>
  <div class="rp-menu-desktop">
    <a href="./index.html">Home</a>
    <a href="./funzioni.html">Funzioni</a>
    <a href="./prezzi.html">Prezzi</a>
    <a href="./firma.html">Firma (demo)</a>
    <a class="rp-accent" href="./login.html">Cambia account</a>
  </div>
  <button id="rpHamburger" class="rp-hamburger" aria-label="Apri menu" aria-expanded="false">‚ò∞</button>
</nav>

<!-- Drawer mobile -->
<aside id="rpDrawer" class="rp-drawer" aria-hidden="true">
  <div class="rp-drawer-head">
    <span class="rp-drawer-title">Men√π</span>
    <button id="rpDrawerClose" class="rp-close" aria-label="Chiudi menu">√ó</button>
  </div>
  <a href="./index.html">Home</a>
  <a href="./funzioni.html">Funzioni</a>
  <a href="./prezzi.html">Prezzi</a>
  <a href="./firma.html">Firma (demo)</a>
  <a class="rp-accent" href="./login.html">Cambia account</a>
</aside>
<div id="rpBackdrop" class="rp-backdrop" hidden></div>

<main class="container">
  <!-- HERO -->
  <section class="hero card" style="display:flex;align-items:flex-start;gap:12px;justify-content:space-between;flex-wrap:wrap">
    <div>
      <h1>Benvenuto, <span id="who">Inquilino</span></h1>
      <p class="lead">Panoramica demo del tuo contratto, dei prossimi pagamenti e delle garanzie.</p>
    </div>
    <div class="actions" style="align-self:center">
      <button class="btn ghost" id="btnLogout" type="button">Logout</button>
    </div>
  </section>

  <!-- KPI CARDS -->
  <div class="section kpis">
    <div class="kpi">
      <h3>üìë Contratto</h3>
      <p id="kpiAddress" style="opacity:.9;margin:.35rem 0">Indirizzo ‚Äî</p>
      <a class="btn ghost" href="firma.html" style="margin-top:6px">Visualizza contratto (demo)</a>
    </div>
    <div class="kpi">
      <h3>üí≥ Prossimo pagamento</h3>
      <p id="kpiNextDate" style="opacity:.9;margin:.35rem 0">Scadenza ‚Äî</p>
      <p id="kpiNextAmount" style="opacity:.9;margin:.35rem 0">Importo ‚Äî</p>
      <button class="btn primary" type="button" disabled>Simula pagamento (coming soon)</button>
    </div>
    <div class="kpi">
      <h3>üõ°Ô∏è Garanzia</h3>
      <p style="opacity:.9;margin:.35rem 0">Copertura attiva contro mancati pagamenti.</p>
      <a class="btn ghost" href="garanzia.html" style="margin-top:6px">Dettagli</a>
    </div>
  </div>

  <!-- DETTAGLI CONTRATTO -->
  <div class="section">
    <div class="section-head">
      <h2>Dettagli contratto</h2>
    </div>
    <div class="table-wrap">
      <table class="table">
        <thead>
          <tr><th>Campo</th><th>Valore</th></tr>
        </thead>
        <tbody>
          <tr><td>Indirizzo</td><td id="tblAddr">‚Äî</td></tr>
          <tr><td>Canone mensile</td><td id="tblRent">‚Äî</td></tr>
          <tr><td>Metodo pagamento</td><td id="tblCard">‚Äî</td></tr>
          <tr><td>Stato</td><td><span class="badge ok">Attivo</span></td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- STORICO PAGAMENTI -->
  <div class="section">
    <div class="section-head"><h2>Storico pagamenti</h2></div>
    <div class="table-wrap">
      <table class="table" id="tblHistory">
        <thead><tr><th>Data</th><th>Riferimento</th><th>Importo</th><th>Esito</th><th>Ricevuta</th></tr></thead>
        <tbody>
          <!-- popolato via JS -->
        </tbody>
      </table>
    </div>
  </div>
</main>

<!-- FOOTER -->
<footer class="footer container">
  <div class="f-links">
    <a href="terms.html">Termini</a>
    <a href="privacy.html">Privacy</a>
    <a href="cookie.html">Cookie</a>
  </div>
  <div class="copy">¬© 2025 RentPay</div>
</footer>

<!-- SCRIPT NAV (uguale alle altre pagine) -->
<script type="text/javascript">
(function(){
  const btn=document.getElementById('rpHamburger'),
        drawer=document.getElementById('rpDrawer'),
        closeBtn=document.getElementById('rpDrawerClose'),
        backdrop=document.getElementById('rpBackdrop');
  function openD(){drawer.classList.add('open');backdrop.hidden=false;backdrop.classList.add('show');document.body.style.overflow='hidden'}
  function closeD(){drawer.classList.remove('open');backdrop.classList.remove('show');backdrop.hidden=true;document.body.style.overflow=''}
  btn&&btn.addEventListener('click',openD);
  closeBtn&&closeBtn.addEventListener('click',closeD);
  backdrop&&backdrop.addEventListener('click',closeD);
  window.addEventListener('keydown',e=>{if(e.key==='Escape')closeD()});
  drawer.querySelectorAll('a').forEach(a=>a.addEventListener('click',closeD));
})();
</script>

<!-- jsPDF per ricevute PDF (demo) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" integrity="sha512-V5b0m3q0U/0O9G0kJ9X4hQ6x0g2b9bM7UjJ2hgh2m8x1F0xG2y8pQ7h6yQ7w7Z7kL1Q1Xh0L9cQKX2j0uM2G6w==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

<!-- SCRIPT DATI DEMO & PERSONALIZZAZIONE -->
<script>
(function(){
  // Dati demo allineati al login
  const demoTenants = [
    { name:'Luca Bianchi',  address:'Via Roma 12, Milano',  rent: 750, card:'Visa **** 4242'   },
    { name:'Giulia Neri',   address:'Via Po 8, Torino',     rent: 720, card:'Mastercard **** 9911' }
  ];

  // Legge ?i=0/1 (fallback a 0)
  const params = new URLSearchParams(location.search);
  const i = Math.max(0, Math.min(1, parseInt(params.get('i') || '0', 10)));
  const t = demoTenants[i];

  // Personalizza header/KPI
  document.getElementById('who').textContent = t.name;
  document.getElementById('kpiAddress').textContent = t.address;
  document.getElementById('kpiNextDate').textContent = 'Scadenza: 01/10';
  const euro = new Intl.NumberFormat('it-IT', { style:'currency', currency:'EUR' }).format(t.rent);
  document.getElementById('kpiNextAmount').textContent = `Importo: ${euro}`;

  // Tabella Dettagli contratto
  document.getElementById('tblAddr').textContent = t.address;
  document.getElementById('tblRent').textContent = `${euro}/mese`;
  document.getElementById('tblCard').textContent = t.card;

  // Storico pagamenti (demo statico coerente col canone)
  const tbody = document.querySelector('#tblHistory tbody');
  const rows = [
    { date:'01/09/2025', ref:'Canone settembre', amount:euro, status:'ok' },
    { date:'01/08/2025', ref:'Canone agosto',    amount:euro, status:'ok' },
    { date:'01/07/2025', ref:'Canone luglio',    amount:euro, status:'ok' }
  ];

  rows.forEach((r, idx)=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${r.date}</td>
      <td>${r.ref}</td>
      <td>${r.amount}</td>
      <td><span class="badge ${r.status==='ok'?'ok':r.status==='warn'?'warn':'err'}">${r.status==='ok'?'Completato':r.status}</span></td>
      <td><button class="btn ghost btn-pdf" data-idx="${idx}" type="button">Ricevuta PDF</button></td>
    `;
    tbody.appendChild(tr);
  });

  // Logout: pulizia e redirect
  document.getElementById('btnLogout').addEventListener('click', ()=>{
    try {
      localStorage.removeItem('rpCurrentUser');
      sessionStorage.clear();
    } catch(e) {}
    window.location.href = './login.html';
  });

  // Genera ricevuta PDF (demo) con jsPDF
  document.querySelectorAll('.btn-pdf').forEach(btn=>{
    btn.addEventListener('click', async (e)=>{
      const idx = parseInt(e.currentTarget.getAttribute('data-idx'), 10);
      const r = rows[idx];

      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();

      // Header
      doc.setFont('helvetica','bold');
      doc.setFontSize(18);
      doc.text('RentPay - Ricevuta di pagamento (DEMO)', 14, 20);

      doc.setFont('helvetica','normal');
      doc.setFontSize(11);
      doc.text(`Intestatario: ${t.name}`, 14, 32);
      doc.text(`Indirizzo immobile: ${t.address}`, 14, 39);

      // Dettagli pagamento
      doc.setFont('helvetica','bold');
      doc.text('Dettagli pagamento', 14, 52);
      doc.setFont('helvetica','normal');
      doc.text(`Data: ${r.date}`, 14, 60);
      doc.text(`Riferimento: ${r.ref}`, 14, 67);
      doc.text(`Importo: ${r.amount}`, 14, 74);
      doc.text(`Esito: Completato`, 14, 81);

      // Nota demo
      doc.setDrawColor(200);
      doc.rect(12, 90, 186, 18);
      doc.setFontSize(10);
      doc.text('Questa √® una ricevuta DEMO generata a fini dimostrativi. Non ha valore fiscale o legale.', 16, 101);

      // Watermark DEMO
      doc.setTextColor(180);
      doc.setFontSize(60);
      doc.setFont('helvetica','bold');
      doc.text('DEMO', 105, 150, { angle: 30, align: 'center' });
      doc.setTextColor(0);

      const fileSafe = `ricevuta_${r.date.replaceAll('/','-')}.pdf`;
      doc.save(fileSafe);
    });
  });

})();
</script>

</body>
</html>
